name: Release Cleaner

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prune:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old releases and tags
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const keep = 5;

            // Fetch all releases (paginated)
            const releases = await github.paginate(
              github.rest.repos.listReleases,
              { owner, repo, per_page: 100 }
            );

            // Sort newest first (safety)
            releases.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const toDelete = releases.slice(keep);

            for (const release of toDelete) {
              core.info(`Deleting release: ${release.name || release.tag_name}`);

              // Delete the release
              await github.rest.repos.deleteRelease({
                owner,
                repo,
                release_id: release.id,
              });

              // Delete the associated tag
              if (release.tag_name) {
                try {
                  await github.rest.git.deleteRef({
                    owner,
                    repo,
                    ref: `tags/${release.tag_name}`,
                  });
                  core.info(`Deleted tag: ${release.tag_name}`);
                } catch (err) {
                  core.warning(`Failed to delete tag ${release.tag_name}: ${err.message}`);
                }
              }
            }

            core.info(`Kept latest ${keep} releases. Deleted ${toDelete.length}.`);
